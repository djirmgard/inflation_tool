<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Der Verm√∂gensvernichter ‚Äì Inflationsrechner</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,700&display=swap" rel="stylesheet">
    <style>
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

        body {
            font-family: 'DM Sans', Verdana, system-ui, sans-serif;
            background: #f7f5f3;
            color: #02193d;
            line-height: 1.5;
            min-height: 100vh;
            letter-spacing: -0.12px;
        }

        .container {
            max-width: 1140px;
            margin: 0 auto;
            padding: 3rem 2rem;
        }

        /* Header */
        header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2.5rem;
        }

        header .left h1 {
            font-size: 2.8rem;
            font-weight: 700;
            color: #02193d;
            line-height: 1.1;
            letter-spacing: -0.44px;
        }

        header .left p {
            color: #5a6b87;
            font-size: 1.05rem;
            margin-top: 0.5rem;
            font-weight: 400;
        }

        header .right {
            text-align: right;
            flex-shrink: 0;
        }

        header .right .label {
            font-size: 0.8rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #5a6b87;
        }

        header .right .big-value {
            font-size: 2.8rem;
            font-weight: 700;
            color: #3096ff;
            line-height: 1.1;
            letter-spacing: -0.44px;
        }

        /* Layout */
        .main-layout {
            display: grid;
            grid-template-columns: 380px 1fr;
            gap: 1.5rem;
            align-items: start;
        }

        /* Controls panel */
        .controls {
            background: #fff;
            border-radius: 32px;
            padding: 2rem;
            border: 1px solid #edebe9;
            transition: box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .slider-group {
            margin-bottom: 1.8rem;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            align-items: baseline;
            margin-bottom: 0.7rem;
        }

        .slider-label span {
            font-size: 0.82rem;
            font-weight: 500;
            color: #5a6b87;
        }

        .slider-label .slider-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #02193d;
        }

        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: #edebe9;
            outline: none;
            cursor: pointer;
            transition: background 0.2s;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #3096ff;
            box-shadow: 0 2px 8px rgba(48, 150, 255, 0.25);
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.15s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            box-shadow: 0 2px 12px rgba(48, 150, 255, 0.4);
            transform: scale(1.08);
        }

        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: #fff;
            border: 3px solid #3096ff;
            box-shadow: 0 2px 8px rgba(48, 150, 255, 0.25);
            cursor: pointer;
        }

        input[type="range"]:disabled {
            opacity: 0.3;
            cursor: default;
        }

        /* Account type selector */
        .account-selector {
            margin-bottom: 1.8rem;
        }

        .account-selector .selector-label {
            font-size: 0.82rem;
            font-weight: 500;
            color: #5a6b87;
            margin-bottom: 0.7rem;
        }

        .account-buttons {
            display: flex;
            gap: 0.6rem;
        }

        .account-btn {
            flex: 1;
            padding: 0.85rem 0.6rem;
            border: 2px solid #edebe9;
            border-radius: 16px;
            background: #fff;
            cursor: pointer;
            text-align: center;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .account-btn:hover {
            border-color: #c9ced6;
            box-shadow: 0 0 0 1px #c9ced6;
        }

        .account-btn.active {
            border-color: #3096ff;
            background: #f0f7ff;
            box-shadow: 0 0 0 2px #3096ff;
        }

        .account-btn .btn-icon {
            font-size: 1.4rem;
            display: block;
            margin-bottom: 0.25rem;
        }

        .account-btn .btn-title {
            font-size: 0.82rem;
            font-weight: 700;
            color: #02193d;
        }

        .account-btn .btn-rate {
            font-size: 0.72rem;
            color: #5a6b87;
            margin-top: 0.15rem;
        }

        .account-btn .btn-rate.loading {
            color: #c9ced6;
        }

        /* Dual range slider */
        .dual-range {
            position: relative;
            height: 6px;
            margin: 14px 0 8px;
        }

        .dual-range .track {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            border-radius: 3px;
            background: #edebe9;
        }

        .dual-range .track-fill {
            position: absolute;
            top: 0;
            height: 6px;
            border-radius: 3px;
            background: #3096ff;
        }

        .dual-range input[type="range"] {
            position: absolute;
            top: -8px;
            width: 100%;
            height: 24px;
            background: transparent;
            pointer-events: none;
            -webkit-appearance: none;
            appearance: none;
        }

        .dual-range input[type="range"]::-webkit-slider-thumb {
            pointer-events: auto;
            position: relative;
            z-index: 2;
        }

        .dual-range input[type="range"]::-moz-range-thumb {
            pointer-events: auto;
            position: relative;
            z-index: 2;
        }

        .year-ticks {
            display: flex;
            justify-content: space-between;
            font-size: 0.7rem;
            color: #9aa5b4;
            margin-top: 4px;
        }

        /* Toggle card */
        .toggle-card {
            background: #f0f7ff;
            border: 1px solid #d6e8ff;
            border-radius: 16px;
            padding: 1rem 1.2rem;
            margin-bottom: 1.8rem;
            display: flex;
            align-items: center;
            gap: 0.8rem;
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle-card.active {
            background: #e3f0ff;
            border-color: #3096ff;
        }

        .toggle-card .icon {
            font-size: 1.4rem;
            flex-shrink: 0;
        }

        .toggle-card .text {
            flex: 1;
        }

        .toggle-card .text .title {
            font-size: 0.88rem;
            font-weight: 700;
            color: #02193d;
        }

        .toggle-card .text .sub {
            font-size: 0.76rem;
            color: #5a6b87;
        }

        .toggle-switch {
            position: relative;
            width: 44px;
            height: 24px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: #c9ced6;
            border-radius: 24px;
            transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle-slider::before {
            content: '';
            position: absolute;
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background: #fff;
            border-radius: 50%;
            transition: 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .toggle-switch input:checked + .toggle-slider {
            background: #3096ff;
        }

        .toggle-switch input:checked + .toggle-slider::before {
            transform: translateX(20px);
        }

        /* Collapsible panels */
        .collapsible-panel {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.3s ease, margin 0.3s ease;
            opacity: 0;
            margin-bottom: 0;
        }

        .collapsible-panel.open {
            max-height: 200px;
            opacity: 1;
            margin-bottom: 1.8rem;
        }

        .panel-inner {
            background: #f0f7ff;
            border: 1px solid #d6e8ff;
            border-radius: 16px;
            padding: 1rem 1.2rem;
        }

        .panel-inner .hint {
            font-size: 0.75rem;
            color: #5a6b87;
            margin-top: 0.35rem;
        }

        .loading-dot {
            display: inline-block;
            animation: blink 1.2s infinite;
        }

        @keyframes blink {
            0%, 80%, 100% { opacity: 0.2; }
            40% { opacity: 1; }
        }

        /* Info callout */
        .info-callout {
            background: #fff8f0;
            border: 1px solid #fde4c8;
            border-radius: 16px;
            padding: 1rem 1.2rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .info-callout .icon {
            font-size: 1.3rem;
            flex-shrink: 0;
            margin-top: 0.1rem;
        }

        .info-callout .text {
            font-size: 0.88rem;
            color: #5a6b87;
            line-height: 1.55;
        }

        .info-callout .text strong {
            color: #02193d;
            font-weight: 700;
        }

        /* Chart area */
        .chart-area {
            background: #fff;
            border-radius: 32px;
            padding: 2rem;
            border: 1px solid #edebe9;
        }

        .chart-container {
            position: relative;
            height: 380px;
        }

        .chart-legend {
            display: flex;
            gap: 1.4rem;
            justify-content: center;
            margin-top: 1.2rem;
            flex-wrap: wrap;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.45rem;
            font-size: 0.8rem;
            color: #5a6b87;
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            flex-shrink: 0;
        }

        .legend-line {
            width: 18px;
            height: 2px;
            flex-shrink: 0;
            border-top: 2px dashed;
        }

        /* Bottom stats */
        .bottom-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-top: 1.2rem;
        }

        .bottom-stat {
            background: #fff;
            border-radius: 24px;
            padding: 1.3rem 1rem;
            text-align: center;
            border: 1px solid #edebe9;
            transition: box-shadow 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .bottom-stat:hover {
            box-shadow: 0 0 0 2px #3096ff;
        }

        .bottom-stat .label {
            font-size: 0.72rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            color: #5a6b87;
            margin-bottom: 0.35rem;
        }

        .bottom-stat .value {
            font-size: 1.5rem;
            font-weight: 700;
            letter-spacing: -0.2px;
        }

        .bottom-stat .sub {
            font-size: 0.72rem;
            color: #9aa5b4;
            margin-top: 0.2rem;
        }

        .bottom-stat .value.red { color: #e04545; }
        .bottom-stat .value.green { color: #1d8a4e; }
        .bottom-stat .value.blue { color: #3096ff; }

        /* Data source */
        .data-source {
            text-align: center;
            margin-top: 2rem;
            font-size: 0.75rem;
            color: #9aa5b4;
        }

        .data-source a {
            color: #3096ff;
            text-decoration: none;
            transition: color 0.2s;
        }

        .data-source a:hover {
            color: #1d5a9a;
            text-decoration: underline;
        }

        @media (max-width: 800px) {
            .main-layout {
                grid-template-columns: 1fr;
            }
            .controls, .chart-area {
                border-radius: 24px;
            }
            .bottom-stat {
                border-radius: 16px;
            }
            header {
                flex-direction: column;
                gap: 1rem;
            }
            header .right {
                text-align: left;
            }
            header .left h1 {
                font-size: 2rem;
            }
            header .right .big-value {
                font-size: 2.2rem;
            }
            .bottom-stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <header>
        <div class="left">
            <h1>Der Verm√∂gensvernichter</h1>
            <p>Beobachte, wie die Inflation dein hart verdientes Erspartes stillschweigend zerst√∂rt.</p>
        </div>
        <div class="right">
            <div class="label">Reale Kaufkraft in <span id="headerYears">10</span> Jahren</div>
            <div class="big-value" id="headerValue">-</div>
        </div>
    </header>

    <div class="main-layout">
        <!-- Left: Controls -->
        <div class="controls">
            <div class="slider-group">
                <div class="slider-label">
                    <span>Aktuelles Erspartes</span>
                    <span class="slider-value" id="savingsDisplay">‚Ç¨10.000</span>
                </div>
                <input type="range" id="savings" min="1000" max="500000" step="1000" value="10000">
            </div>

            <!-- Account type -->
            <div class="account-selector">
                <div class="selector-label">Kontoart</div>
                <div class="account-buttons">
                    <div class="account-btn active" data-type="girokonto" onclick="selectAccount('girokonto')">
                        <span class="btn-icon">üè¶</span>
                        <div class="btn-title">Girokonto</div>
                        <div class="btn-rate">0,00% Zinsen</div>
                    </div>
                    <div class="account-btn" data-type="tagesgeld" onclick="selectAccount('tagesgeld')">
                        <span class="btn-icon">üí∞</span>
                        <div class="btn-title">Tagesgeld</div>
                        <div class="btn-rate loading" id="tagesgeldRate">Lade Zins...</div>
                    </div>
                </div>
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>Durchschn. Inflationsrate</span>
                    <span class="slider-value" id="inflationDisplay">5%</span>
                </div>
                <input type="range" id="inflation" min="0.5" max="15" step="0.1" value="5">
            </div>

            <div class="toggle-card" id="toggleCard">
                <div class="icon">üìã</div>
                <div class="text">
                    <div class="title">Echte Inflation (Historische Daten)</div>
                    <div class="sub">Basierend auf Eurozone HVPI-Daten</div>
                </div>
                <label class="toggle-switch">
                    <input type="checkbox" id="historicToggle">
                    <span class="toggle-slider"></span>
                </label>
            </div>

            <div class="collapsible-panel" id="historicPanel">
                <div class="panel-inner">
                    <div class="slider-label">
                        <span>Historischer Zeitraum</span>
                        <span class="slider-value" id="yearRangeDisplay">2015 ‚Äì 2025</span>
                    </div>
                    <div class="dual-range">
                        <div class="track"></div>
                        <div class="track-fill" id="trackFill"></div>
                        <input type="range" id="yearFrom" min="2000" max="2025" step="1" value="2015">
                        <input type="range" id="yearTo" min="2000" max="2025" step="1" value="2025">
                    </div>
                    <div class="year-ticks">
                        <span>2000</span><span>2005</span><span>2010</span><span>2015</span><span>2020</span><span>2025</span>
                    </div>
                    <div class="hint" id="historicHint">Lade Daten von Eurostat...</div>
                </div>
            </div>

            <div class="slider-group">
                <div class="slider-label">
                    <span>Zeitraum</span>
                    <span class="slider-value" id="yearsDisplay">10 Jahre</span>
                </div>
                <input type="range" id="years" min="1" max="50" step="1" value="10">
            </div>

            <div class="info-callout">
                <div class="icon">üïê</div>
                <div class="text" id="calloutText">-</div>
            </div>
        </div>

        <!-- Right: Chart + Stats -->
        <div>
            <div class="chart-area">
                <div class="chart-container">
                    <canvas id="mainChart"></canvas>
                </div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-line" style="border-color: #02193d;"></div>
                        <span>Anfangswert</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-dot" style="background: #02193d;"></div>
                        <span>Girokonto (real)</span>
                    </div>
                    <div class="legend-item" id="legendTagesgeld" style="display:none;">
                        <div class="legend-dot" style="background: #3096ff;"></div>
                        <span>Tagesgeld (real)</span>
                    </div>
                </div>
            </div>
            <div class="bottom-stats">
                <div class="bottom-stat">
                    <div class="label">Kaufkraftverlust</div>
                    <div class="value red" id="statLost">-</div>
                    <div class="sub" id="statLostSub"></div>
                </div>
                <div class="bottom-stat">
                    <div class="label">Wert erhalten</div>
                    <div class="value green" id="statRetained">-</div>
                    <div class="sub" id="statRetainedSub"></div>
                </div>
                <div class="bottom-stat" id="statTagesgeldCard">
                    <div class="label" id="statCompareLabel">Tagesgeld-Vorteil</div>
                    <div class="value blue" id="statCompare">-</div>
                    <div class="sub" id="statCompareSub">vs. Girokonto</div>
                </div>
            </div>
        </div>
    </div>

    <div class="data-source">
        Inflationsdaten: <a href="https://ec.europa.eu/eurostat" target="_blank">Eurostat HVPI</a> ¬∑
        Tagesgeldzins: <a href="https://data.ecb.europa.eu" target="_blank">EZB MFI-Zinsstatistik</a> (DE, Einlagen privater Haushalte, Neugesch√§ft)
    </div>
</div>

<script>
    // ‚îÄ‚îÄ State ‚îÄ‚îÄ
    let eurostatData = {};
    let eurostatLoaded = false;
    let overnightRate = null;       // fetched from ECB, e.g. 0.44
    let overnightRatePeriod = '';
    let selectedAccount = 'girokonto';
    let chart;

    // ‚îÄ‚îÄ API URLs ‚îÄ‚îÄ
    const EUROSTAT_URL =
        'https://ec.europa.eu/eurostat/api/dissemination/sdmx/2.1/data/prc_hicp_aind/A.RCH_A_AVG.CP00.EA/?format=JSON&startPeriod=2000&endPeriod=2025';

    const ECB_MIR_URL =
        'https://data-api.ecb.europa.eu/service/data/MIR/M.DE.B.L21.A.R.A.2250.EUR.N?format=jsondata&lastNObservations=1';

    // ‚îÄ‚îÄ Fetch ECB overnight rate ‚îÄ‚îÄ
    async function fetchOvernightRate() {
        try {
            const res = await fetch(ECB_MIR_URL);
            const json = await res.json();

            const seriesKey = Object.keys(json.dataSets[0].series)[0];
            const obs = json.dataSets[0].series[seriesKey].observations;
            const obsKey = Object.keys(obs)[0];
            const rate = obs[obsKey][0];

            const timeDim = json.structure.dimensions.observation.find(d => d.id === 'TIME_PERIOD');
            const period = timeDim ? timeDim.values[0].name : '';

            overnightRate = rate;
            overnightRatePeriod = period;

            const el = document.getElementById('tagesgeldRate');
            el.textContent = rate.toFixed(2).replace('.', ',') + '% Zinsen';
            el.classList.remove('loading');

            update();
        } catch (err) {
            console.error('ECB MIR fetch failed:', err);
            overnightRate = 0.44;
            overnightRatePeriod = 'Fallback';
            const el = document.getElementById('tagesgeldRate');
            el.textContent = '0,44% Zinsen';
            el.classList.remove('loading');
            update();
        }
    }

    // ‚îÄ‚îÄ Fetch Eurostat HICP ‚îÄ‚îÄ
    async function fetchEurostat() {
        try {
            document.getElementById('historicHint').innerHTML =
                'Lade HVPI-Daten von Eurostat<span class="loading-dot">...</span>';

            const res = await fetch(EUROSTAT_URL);
            const json = await res.json();

            const timeDim = json.dimension.time;
            const yearIndex = timeDim.category.index;
            const values = json.value;

            for (const [year, idx] of Object.entries(yearIndex)) {
                if (values[idx] !== undefined) {
                    eurostatData[parseInt(year)] = values[idx];
                }
            }

            eurostatLoaded = true;
            const years = Object.keys(eurostatData).sort();
            const minY = years[0], maxY = years[years.length - 1];

            document.getElementById('yearFrom').min = minY;
            document.getElementById('yearFrom').max = maxY;
            document.getElementById('yearTo').min = minY;
            document.getElementById('yearTo').max = maxY;

            document.getElementById('historicHint').innerHTML =
                `${years.length} Jahre geladen (${minY}‚Äì${maxY}) ¬∑ Quelle: Eurostat HVPI`;

            update();
        } catch (err) {
            console.error('Eurostat fetch failed:', err);
            document.getElementById('historicHint').innerHTML = 'Fehler. Verwende Fallback-Daten.';
            useFallback();
        }
    }

    function useFallback() {
        const fb = [
            [2000,2.1],[2001,2.4],[2002,2.3],[2003,2.1],[2004,2.2],
            [2005,2.2],[2006,2.2],[2007,2.2],[2008,3.3],[2009,0.3],
            [2010,1.6],[2011,2.7],[2012,2.5],[2013,1.4],[2014,0.4],
            [2015,0.2],[2016,0.2],[2017,1.5],[2018,1.8],[2019,1.2],
            [2020,0.3],[2021,2.6],[2022,8.4],[2023,5.4],[2024,2.4]
        ];
        fb.forEach(([y, r]) => { eurostatData[y] = r; });
        eurostatLoaded = true;
        update();
    }

    // ‚îÄ‚îÄ Formatting ‚îÄ‚îÄ
    function fmtEuro(val) {
        return '‚Ç¨' + Math.round(Math.abs(val)).toLocaleString('de-DE');
    }

    function fmtK(val) {
        if (val >= 1000) return '‚Ç¨' + Math.round(val / 1000) + 'k';
        return '‚Ç¨' + Math.round(val);
    }

    // ‚îÄ‚îÄ Account selection ‚îÄ‚îÄ
    function selectAccount(type) {
        selectedAccount = type;
        document.querySelectorAll('.account-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.type === type);
        });
        update();
    }

    // ‚îÄ‚îÄ Values ‚îÄ‚îÄ
    function getValues() {
        const useHistoric = document.getElementById('historicToggle').checked;
        let yearFrom = parseInt(document.getElementById('yearFrom').value);
        let yearTo = parseInt(document.getElementById('yearTo').value);
        if (yearFrom > yearTo) [yearFrom, yearTo] = [yearTo, yearFrom];

        const interestRate = selectedAccount === 'tagesgeld' && overnightRate !== null
            ? overnightRate / 100 : 0;

        return {
            savings: parseFloat(document.getElementById('savings').value),
            inflation: parseFloat(document.getElementById('inflation').value) / 100,
            years: parseInt(document.getElementById('years').value),
            useHistoric, yearFrom, yearTo,
            interestRate,
            accountType: selectedAccount,
        };
    }

    function getHistoricRates(v) {
        const rates = [];
        for (let y = v.yearFrom; y <= v.yearTo; y++) {
            if (eurostatData[y] !== undefined) rates.push(eurostatData[y]);
        }
        return rates;
    }

    function getInflationRate(v, yearIdx, historicRates) {
        if (v.useHistoric && historicRates.length > 0) {
            return historicRates[(yearIdx - 1) % historicRates.length] / 100;
        }
        return v.inflation;
    }

    // ‚îÄ‚îÄ Calculation ‚îÄ‚îÄ
    function calculate() {
        const v = getValues();
        let historicRates = [];
        if (v.useHistoric && eurostatLoaded) {
            historicRates = getHistoricRates(v);
        }

        // Girokonto: 0% interest, just inflation decay
        const giroData = [v.savings];
        for (let y = 1; y <= v.years; y++) {
            const inflRate = getInflationRate(v, y, historicRates);
            // Nominal stays same (0% interest), real = nominal / cumulative inflation
            giroData.push(giroData[y - 1] / (1 + inflRate));
        }

        // Tagesgeld: overnight rate interest, minus inflation
        const tagesgeldData = [v.savings];
        const rate = overnightRate !== null ? overnightRate / 100 : 0;
        let tagesgeldNominal = v.savings;
        for (let y = 1; y <= v.years; y++) {
            const inflRate = getInflationRate(v, y, historicRates);
            tagesgeldNominal *= (1 + rate);
            const cumulativeInflation = v.savings > 0 ? tagesgeldNominal : 0;
            // Real value: grow by interest, then deflate
            tagesgeldData.push(tagesgeldData[y - 1] * (1 + rate) / (1 + inflRate));
        }

        return { giroData, tagesgeldData, values: v, historicRates };
    }

    // ‚îÄ‚îÄ Slider fill ‚îÄ‚îÄ
    function updateSliderFill(slider) {
        if (slider.disabled) return;
        const pct = (slider.value - slider.min) / (slider.max - slider.min) * 100;
        slider.style.background = `linear-gradient(to right, #3096ff ${pct}%, #edebe9 ${pct}%)`;
    }

    function updateDualRange() {
        let from = parseInt(document.getElementById('yearFrom').value);
        let to = parseInt(document.getElementById('yearTo').value);
        if (from > to) [from, to] = [to, from];

        const min = parseInt(document.getElementById('yearFrom').min);
        const max = parseInt(document.getElementById('yearFrom').max);
        const range = max - min || 1;

        const leftPct = ((from - min) / range) * 100;
        const rightPct = ((to - min) / range) * 100;

        document.getElementById('trackFill').style.left = leftPct + '%';
        document.getElementById('trackFill').style.width = (rightPct - leftPct) + '%';
        document.getElementById('yearRangeDisplay').textContent = from + ' ‚Äì ' + to;
    }

    // ‚îÄ‚îÄ Main update ‚îÄ‚îÄ
    function update() {
        const { giroData, tagesgeldData, values: v, historicRates } = calculate();

        const activeData = v.accountType === 'tagesgeld' ? tagesgeldData : giroData;
        const finalValue = activeData[activeData.length - 1];
        const lost = v.savings - finalValue;
        const retained = (finalValue / v.savings) * 100;

        const giroFinal = giroData[giroData.length - 1];
        const tagesgeldFinal = tagesgeldData[tagesgeldData.length - 1];
        const tagesgeldAdvantage = tagesgeldFinal - giroFinal;

        // Header
        document.getElementById('savingsDisplay').textContent = fmtEuro(v.savings);
        document.getElementById('inflationDisplay').textContent = (v.inflation * 100).toFixed(1) + '%';
        document.getElementById('yearsDisplay').textContent = v.years + ' Jahre';
        document.getElementById('headerYears').textContent = v.years;
        document.getElementById('headerValue').textContent = fmtEuro(finalValue);

        // Stats
        document.getElementById('statLost').textContent = '-' + fmtEuro(lost);
        document.getElementById('statLostSub').textContent =
            v.accountType === 'tagesgeld' ? 'auf Tagesgeldkonto' : 'auf Girokonto';

        document.getElementById('statRetained').textContent = Math.round(retained) + '%';
        document.getElementById('statRetainedSub').textContent = 'der Kaufkraft';

        document.getElementById('statCompare').textContent = '+' + fmtEuro(tagesgeldAdvantage);
        document.getElementById('statCompareSub').textContent =
            overnightRate !== null
                ? `bei ${overnightRate.toFixed(2).replace('.', ',')}% Tagesgeldzins`
                : 'vs. Girokonto';

        // Callout
        if (v.useHistoric && historicRates.length > 0) {
            const avg = historicRates.reduce((a, b) => a + b, 0) / historicRates.length;
            const accountLabel = v.accountType === 'tagesgeld' ? 'Tagesgeldkonto' : 'Girokonto';
            document.getElementById('calloutText').innerHTML =
                `Bei durchschnittlich <strong>${avg.toFixed(1)}%</strong> historischer Inflation (${v.yearFrom}‚Äì${v.yearTo}) verlierst du auf dem <strong>${accountLabel}</strong> insgesamt <strong>${fmtEuro(lost)}</strong> an Kaufkraft.`;
        } else {
            const rateLabel = v.accountType === 'tagesgeld' && overnightRate !== null
                ? ` und <strong>${overnightRate.toFixed(2).replace('.', ',')}%</strong> Tagesgeldzins`
                : ' auf dem <strong>Girokonto</strong>';
            document.getElementById('calloutText').innerHTML =
                `Bei <strong>${(v.inflation * 100).toFixed(1)}%</strong> Inflation${rateLabel} verlierst du <strong>${fmtEuro(v.savings * v.inflation)}</strong> Kaufkraft im ersten Jahr.`;
        }

        // Slider fills
        updateSliderFill(document.getElementById('savings'));
        updateSliderFill(document.getElementById('inflation'));
        updateSliderFill(document.getElementById('years'));
        updateDualRange();

        // Toggle inflation slider
        const inflSlider = document.getElementById('inflation');
        inflSlider.disabled = v.useHistoric;
        document.getElementById('inflationDisplay').style.opacity = v.useHistoric ? '0.35' : '1';

        // Toggle panel
        const panel = document.getElementById('historicPanel');
        const card = document.getElementById('toggleCard');
        if (v.useHistoric) {
            panel.classList.add('open');
            card.classList.add('active');
        } else {
            panel.classList.remove('open');
            card.classList.remove('active');
        }

        // Legend
        document.getElementById('legendTagesgeld').style.display =
            v.accountType === 'tagesgeld' ? 'flex' : 'none';

        updateChart(giroData, tagesgeldData, v);
    }

    // ‚îÄ‚îÄ Chart ‚îÄ‚îÄ
    function updateChart(giroData, tagesgeldData, v) {
        const labels = Array.from({ length: v.years + 1 }, (_, i) => i);
        const topLine = new Array(v.years + 1).fill(v.savings);

        const datasets = [
            {
                label: 'Anfangswert',
                data: topLine,
                borderColor: '#02193d',
                borderWidth: 2,
                borderDash: [6, 4],
                pointRadius: 0,
                fill: false,
                order: 3,
            },
            {
                label: 'Girokonto (real)',
                data: giroData,
                borderColor: '#02193d',
                borderWidth: 2.5,
                backgroundColor: 'rgba(2, 25, 61, 0.08)',
                fill: { target: 0, above: 'rgba(2, 25, 61, 0.12)' },
                pointRadius: 0,
                tension: 0.3,
                order: 2,
            },
        ];

        if (v.accountType === 'tagesgeld') {
            datasets.push({
                label: 'Tagesgeld (real)',
                data: tagesgeldData,
                borderColor: '#3096ff',
                borderWidth: 2.5,
                backgroundColor: 'rgba(48, 150, 255, 0.06)',
                fill: false,
                pointRadius: 0,
                tension: 0.3,
                order: 1,
            });
        }

        if (chart) chart.destroy();

        chart = new Chart(document.getElementById('mainChart'), {
            type: 'line',
            data: { labels, datasets },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: { intersect: false, mode: 'index' },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: '#fff',
                        titleColor: '#333',
                        bodyColor: '#555',
                        borderColor: '#e0e0e0',
                        borderWidth: 1,
                        padding: 12,
                        displayColors: true,
                        callbacks: {
                            title: (items) => 'Jahr ' + items[0].label,
                            label: (ctx) => ctx.dataset.label + ': ' + fmtEuro(ctx.parsed.y),
                        }
                    }
                },
                scales: {
                    x: {
                        grid: { color: 'rgba(0,0,0,0.04)', drawBorder: false },
                        ticks: { color: '#999', font: { size: 12 }, maxTicksLimit: 12 },
                        border: { dash: [4, 4] }
                    },
                    y: {
                        grid: { color: 'rgba(0,0,0,0.06)', drawBorder: false },
                        ticks: { color: '#999', font: { size: 12 }, callback: val => fmtK(val) },
                        border: { dash: [4, 4] },
                        min: (() => {
                            const allValues = datasets.flatMap(d => d.data);
                            const minVal = Math.min(...allValues);
                            const maxVal = Math.max(...allValues);
                            const drop = maxVal - minVal;
                            return Math.max(0, Math.floor((minVal - drop) / 1000) * 1000);
                        })(),
                    }
                }
            }
        });
    }

    // ‚îÄ‚îÄ Events ‚îÄ‚îÄ
    ['savings', 'inflation', 'years'].forEach(id => {
        document.getElementById(id).addEventListener('input', update);
    });
    ['yearFrom', 'yearTo'].forEach(id => {
        document.getElementById(id).addEventListener('input', update);
    });
    document.getElementById('historicToggle').addEventListener('change', () => {
        if (document.getElementById('historicToggle').checked && !eurostatLoaded) {
            fetchEurostat();
        }
        update();
    });

    // ‚îÄ‚îÄ Init ‚îÄ‚îÄ
    fetchOvernightRate();
    update();
</script>
</body>
</html>
